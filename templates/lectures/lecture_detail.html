{% extends '../base.html' %}
{% load crispy_forms_tags %}
{% load embed_video_tags %}
{% load class_name %}
{% block content %}

<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
      {% if user.is_student %}
      <li class="breadcrumb-item"><a href="{% url 'enrolled_course_list'  %}">Course list</a></li>
      <li class="breadcrumb-item"><a href="{% url 'student_course_lectures' lecture.course.pk %}">Lecture list</a></li>
      {% else %}
    <li class="breadcrumb-item"><a href="{% url 'lecture_list' %}">lecture list</a></li>
      {% endif %}
      <li class="breadcrumb-item active" aria-current="page">lecture detail</li>
    </ol>
</nav>

{% if messages %}
    {% for message in messages %}
      {% if message.tags == 'error' %}
          <div class="alert alert-danger" style="width: 50%;  margin: auto;">
              {{ message }}
          </div>
      {%else %}
          <div class="alert alert-{{ message.tags }}" style="width: 50%;  margin: auto;">
              {{ message }}
          </div>
      {% endif %}
    {% endfor %}
{% endif %}

<div class="card" style="width: 55rem;">

  <ul class="list-group list-group-flush">
    {% if user.is_student %}
    <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight" style="width: 7rem; margin-left: 47.8rem;">Resources</button>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
      <div class="offcanvas-header">
        <h5 id="offcanvasRightLabel">Resources</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      {% if resource %}

      <div class="offcanvas-body">
      {% for resource in lecture.resources.all %}
        {% if resource.resource_file %}
        {% if resource.resource_file.url|endswith:".jpg" or resource.resource_file.url|endswith:".jpeg" or resource.resource_file.url|endswith:".png" %}
          <div class="d-flex justify-content-center" style="display: inline-block;">

            <ul class="list-group border border-success " style="width: 8rem;  border: 2px solid black;" >
              <li class="list-group-item border border-primary"><img src="{{ resource.resource_file.url }}" alt="{{ resource.title }}" style="max-width: 100%;" height="200px" ></li>
              <li class="list-group-item border border-warning"><a href="{{ resource.resource_file.url }}" download><i class="fas fa-download"></i></a></li>
              <br>
            </ul>
          </div>
            <hr>
            <br>
            {% elif resource.resource_file.url|endswith:".pdf" or resource.resource_file.url|endswith:".docx" %}
            <ul class="list-group border border-success">
            <li class="list-group-item border border-primary"><iframe src="{{ resource.resource_file.url }}" style="width:100%; height:300px;" ></iframe></li>
            <li class="list-group-item border border-warning"><a href="{{ resource.resource_file.url }}" download><i class="fas fa-download"></i></a></li>
          </ul>
          {% elif resource.resource_file.url|endswith:".mp4" or resource.resource_file.url|endswith:".webm" %}
          
          <video controls style="max-width: 100%;">
            <source src="{{ resource.resource_file.url }}" type="video/mp4">
            Your browser does not support the video tag.
              </video>
              <ul class="list-group border border-success">
                <li class="list-group-item border border-primary"><video controls style="max-width: 100%;">
                  <source src="{{ resource.resource_file.url }}" type="video/mp4">
                  Your browser does not support the video tag.
              </video></li>
                <li class="list-group-item border border-warning"><a href="{{ resource.resource_file.url }}" download><i class="fas fa-download"></i></a></li>
              </ul>
              {% else %}
              <ul class="list-group border border-success">
                <li class="list-group-item border border-primary"><a href="{{ resource.resource_file.url }}">View File</a></li>
                <li class="list-group-item border border-warning"><a href="{{ resource.resource_file.url }}" download><i class="fas fa-download"></i></a></li>
          </ul>
          {% endif %}
          
          {% else %}
          <p>No file available</p>
          {% endif %}

        {% endfor %}
      </div>
      {% else %}
      <div class="offcanvas-body">
        <p>No resources available</p>
      </div>
      {% endif %} 
    </div>
    {% endif %}
    <li class="list-group-item"><h2>Lecture: {{ lecture.title }}</h2></li>
    <li class="list-group-item">Course: {{ lecture.course }}</li>
    {% comment %}
    <li class="list-group-item">Video: 
      {% video lecture.video as my_video %}
  Url: {{ my_video.url }}
  Thumbnail: {{ my_video.thumbnail }}
  Backend: {{ my_video.backend }}
  {% video my_video "800x400" %}
  {{ my_video.thumbnail }}
  {{ my_video.backend }}
  {{my_video.url}}
  <iframe id="lecture-video" src="{{ my_video.url }}" frameborder="0" width="800" height="400" allowfullscreen></iframe>
  {% endvideo %}
</li>
  {% endcomment %}
  <li class="list-group-item">
    Video:
    <div id="player-container">
        <div id="player" style="border: solid 4px #37474F" ></div>
        <div id="question-overlay" style="display: none;">
            <h3>Question</h3>
            <p id="question-text"></p>
            <form id="question-form">
                <input type="text" id="answer" placeholder="Your answer" required>
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>
        </div>
    </div>
</li>
    <li class="list-group-item"><p class="text-break">description: {{ lecture.description | safe }}</p></li>
  </ul>

</div>
<hr>
{% if user.is_student %}
{% if completed %}
<form method="post" action="{% url 'incomplete_lecture' lecture.pk %}">
  {% csrf_token %}
  <button type="submit" class="btn btn-primary">Mark as incomplete </button>
</form>
{% else %}
<form method="post" action="{% url 'complete_lecture' lecture.pk %}"  id="complete-form" style="display: none;">
  {% csrf_token %}
  <button type="submit" class="btn btn-primary">Mark as complete</button>
</form>
{% endif %}
{% endif %}

{% if user.is_superuser %}
 <a href="{% url 'lecture_create'%}" class="btn btn-primary"><i class="fa fa-plus" aria-hidden="true"></i></a>
<a href="{% url 'lecture_delete' lecture.pk %}" class="btn btn-danger"><i class="fa fa-trash-o" aria-hidden="true"></i></a>

{% endif %}

{% if  user.is_admin or user.is_professor %}
<!-- Button trigger modal -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
  <i class="fa fa-pencil-square-o" aria-hidden="true"></i>
</button>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Edit Lecture</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          {{ form.media }}
          {{ form | crispy }}
          <button type="submit" class="btn btn-primary">Submit</button>
        </form>
      </div>
      <!-- <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div> -->
    </div>
  </div>
</div>
<a href="{% url 'lecture_delete' lecture.pk %}" class="btn btn-danger"><i class="fa fa-trash-o" aria-hidden="true"></i></a>
{% endif %}
<script>

  console.log('video id');
  {% video lecture.video as my_video %}
var vidoe_url= "{{ my_video.url }}";
var vidoe_id = vidoe_url.split("/")[4];
var vidoe_id = vidoe_id.split("?")[0];
console.log('video id');
console.log(vidoe_id);
  {% endvideo %}

  var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player;
        var questions = [
        {% for question in lecture.lecture_questions.all %}
          { 
            time: parseFloat("{{ question.time }}") * 60, 
            question: "{{ question.question }}", 
            answer: "{{ question.answer }}" 
          },
        {% endfor %}
        ];
        var nextQuestionIndex = 0;
        var questionDisplayed = false;
        var watchedIntervals = [];

        questions.sort(function(a, b) {
            return a.time - b.time;
        });

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '400',
                width: '800',
                videoId: vidoe_id,
                events: {
                    'onStateChange': onPlayerStateChange,
                    'onPlaybackRateChange': preventSkipping,
                    'onError': handlePlayerError,
                    'onReady': onPlayerReady
                }
            });
        }

        function onPlayerReady(event) {
            setInterval(trackVideoProgress, 1000);
            document.getElementById('player').style.borderColor = '#FF6D00';
        }

        function trackVideoProgress() {
            if (player.getPlayerState() == YT.PlayerState.PLAYING) {
                var currentTime = Math.floor(player.getCurrentTime());
                if (!watchedIntervals.includes(currentTime)) {
                    watchedIntervals.push(currentTime);
                }
                checkTime();
            }
        }

        function changeBorderColor(playerStatus) {
            var color;
            if (playerStatus == -1) {
              color = "#37474F"; // unstarted = gray
            } else if (playerStatus == 0) {
              color = "#FFFF00"; // ended = yellow
            } else if (playerStatus == 1) {
              color = "#33691E"; // playing = green
            } else if (playerStatus == 2) {
              color = "#DD2C00"; // paused = red
            } else if (playerStatus == 3) {
              color = "#AA00FF"; // buffering = purple
            } else if (playerStatus == 5) {
              color = "#FF6DOO"; // video cued = orange
            }
            if (color) {
              document.getElementById('player').style.borderColor = color;
            }
        }

        function preventSkipping(event) {
            if (player.getPlaybackRate() > 1) {
                player.setPlaybackRate(1);
            }
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.ENDED) {
              console.log('video ended');
              console.log('watchedinterval:', watchedIntervals.length);
              console.log('player duration:',player.getDuration());
              console.log(questions.length);
              console.log(nextQuestionIndex);
              handleVideoEnd();
                if (player.getDuration() <= watchedIntervals.length && nextQuestionIndex >= questions.length) {
                    document.getElementById('complete-form').style.display = 'block';
                }
                else if (player.getDuration() > watchedIntervals.length) {
                    alert("Please watch the entire video to mark it as complete.");
                }
                else if (nextQuestionIndex < questions.length) {
                    alert("Please answer the question to mark the video as complete.");
                }
            } else if (event.data == YT.PlayerState.PLAYING) {
                checkTime();
            }
            changeBorderColor(event.data);
        }

        function handlePlayerError(event) {
            if (event.data == 100 || event.data == 101 || event.data == 150) {
                alert("This video cannot be played.");
            }
        }

        function handleVideoEnd() {
            var duration = Math.floor(player.getDuration());
            if (!watchedIntervals.includes(duration)) {
                watchedIntervals.push(duration);
            }     
            // displayMarkAsCompleteButton();
        }

        function checkTime() {
            if (questionDisplayed) {
                return;
            }
            var currentTime = player.getCurrentTime();
            if (nextQuestionIndex < questions.length && currentTime >= questions[nextQuestionIndex].time) {
                player.pauseVideo();
                showQuestion(questions[nextQuestionIndex]);
                nextQuestionIndex++;
                questionDisplayed = true;
            }
        }

        function showQuestion(question) {
            document.getElementById('question-text').textContent = question.question;
            document.getElementById('question-overlay').style.display = 'block';
            document.getElementById('question-form').onsubmit = function(event) {
                event.preventDefault();
                var answer = document.getElementById('answer').value.trim().toLowerCase();
                if (answer === question.answer.toLowerCase()) {
                    document.getElementById('question-overlay').style.display = 'none';
                    questionDisplayed = false;
                    player.playVideo();
                } else {
                    alert("Incorrect answer. Please try again.");
                }
            };
        }

      function displayMarkAsCompleteButton() {
          document.getElementById('complete-form').style.display = 'block';
      }
</script>

<style>
  #player-container {
      position: relative;
      width: 640px;
      height: 390px;
  }
  #question-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
  }
</style>

{% endblock content %}
