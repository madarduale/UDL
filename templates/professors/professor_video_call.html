<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Professor Video Call</title>
</head>
<body>
    <h1>Professor Video Call</h1>
    <video id="localVideo" autoplay></video>
    <video id="remoteVideo" autoplay></video>

    <div>
        <button id="toggleVideo">Disable Video</button>
        <button id="toggleAudio">Disable Audio</button>
    </div>

    <script>
        // Video Call
        const studentsVideos = document.getElementById('studentsVideos');
        const toggleVideoButton = document.getElementById('toggleVideo');
        const toggleAudioButton = document.getElementById('toggleAudio');
        const professorId = "{{ professor_id }}"; 
        const socket = new WebSocket('ws://' + window.location.host + '/ws/video-call/' + professorId + '/');

        let VideoEnabled = true;
        let AudioEnabled = true;
  
        const peerConnections = {};

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            handleSignalingData(data);
        };

        socket.onopen = function(event) {
            console.log('WebSocket is connected.');
        };

        socket.onclose = function(event) {
            console.log('WebSocket is closed.');
        };

        function createPeerConnection(studentId) {
            const peerConnection = new RTCPeerConnection();

            peerConnection.onicecandidate = function(event) {
                if (event.candidate) {
                    socket.send(JSON.stringify({ type: 'candidate', candidate: event.candidate, student_id: studentId, professor_id: professorId }));
                }
            };

            peerConnection.ontrack = function(event) {
                const remoteVideo = document.createElement('video');
                remoteVideo.srcObject = event.streams[0];
                remoteVideo.autoplay = true;
                remoteVideo.controls = true;
                studentsVideos.appendChild(remoteVideo);
            };

            peerConnections[studentId] = peerConnection;

            return peerConnection;
        }

        function handleSignalingData(data) {
            switch(data.type) {
                case 'join':
                    const peerConnection = createPeerConnection(data.student_id);
                    peerConnection.createOffer()
                        .then(offer => {
                            peerConnection.setLocalDescription(offer);
                            socket.send(JSON.stringify({ type: 'offer', offer: offer, student_id: data.student_id, professor_id: professorId }));
                        });
                    break;
                case 'answer':
                    peerConnections[data.student_id].setRemoteDescription(new RTCSessionDescription(data.answer));
                    break;
                case 'candidate':
                    peerConnections[data.student_id].addIceCandidate(new RTCIceCandidate(data.candidate));
                    break;
            }
        }
toggleVideoButton.onclick = function() {
    videoEnabled = !videoEnabled;
    localStream.getVideoTracks()[0].enabled = videoEnabled;
    toggleVideoButton.textContent = videoEnabled ? 'Disable Video' : 'Enable Video';
};

toggleAudioButton.onclick = function() {
    audioEnabled = !audioEnabled;
    localStream.getAudioTracks()[0].enabled = audioEnabled;
    toggleAudioButton.textContent = audioEnabled ? 'Disable Audio' : 'Enable Audio';
};
    </script>
</body>
</html>
